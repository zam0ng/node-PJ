<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="http://13.209.64.80/socket.io/socket.io.js"></script>
<link rel="stylesheet" href="./css/admin.css">
<link rel="stylesheet" href="./css/adminchat.css">
<body>
    <div class="main-box">
        <div class="title">
            
        <a href="/index.html"><img src="http://13.209.64.80/img/White_logo_-_no_background.png" class="title-img" alt=""></a>
            

        </div>
        <div class="agree">
            <div class="agreelist">
                <div class="al">
                    <div id="user_agree">가입 승인</div>
                    <div id="post_agree">게시글 관리</div>
                    <div id="chat_agree">고객 문의</div>
                </div>

            </div>
            <div class="content">
                <div id="tab_title">가입 승인</div>
                <div id="reject_reason">

                        <label for="" id="">반려사유</label>
                        <select id="reason">
                            <option value="1">부적절한 책표지</option>
                            <option value="2">부적절한 책제목</option>
                            <option value="3">부적절한 책내용</option>
                            <option value="4">내용과 장르선택 불일치 </option>
                            
                        </select>
                        <button id="rejectbtn">보내기</button>
                        <button id="closee">닫기</button>
                        
                    
                </div>
                <div id="main_content"></div>
                <div id="main_content2"></div>

                <div id="main_content3">
                    <div style="display: flex;">
                    <div id="chat_list">
                        <ul class="chat_user_id">
                            
                           
                        </ul>
                    </div>
                    <div id="chat_room">
                        <div id="who_room"></div>
                        <div class="text-box">
                            <div class="chatArea"></div>
                        </div>
                        <div id="send">
                            <input type="text" placeholder="Please enter your message" name="" id="adminMsg">
                            <button class="btn-style" id="sendBtn">send</button>
                        </div>
                    </div>
                </div>
                </div>

            </div>
        </div>

        
</body>
<script src="./js/address.js"></script>
<script>
    
    //
    window.onload
    = async() =>{
    
    tab_title.innerText = "가입 승인";
    user_agree.style.color ="black";
    post_agree.style.color ="rgb(158, 158, 158)";
    chat_agree.style.color ="rgb(158, 158, 158)";
    reject_reason.style.visibility = "hidden";
    main_content3.style.display= "none";

    const data =await axios.get(`${backend}/nonagreeuser`,{

        withCredentials:true,
    })
    main_content.innerHTML ="";

    console.log(data);

    if(data.data.length==0){
        return main_content.innerHTML =`가입 승인 대기중인 유저가 없습니다.`
    }

    main_content.innerHTML =`
                    <br>
                    <table class="tb">
                        <th class="num">num</th>
                        <th class="user_id">user_id</th>
                        <th class="gender">M/W</th>
                        <th class="role">W/R</th>
                        <th class="age">age</th>
                        <th class="nickname">nickname</th>
                    </table>`
    // console.log(data);
    // console.log(data.data);

    data.data.forEach((el,index) => {
        
        main_content.innerHTML += 
        `       <div style="display:flex">
                    <table class="tb">
                        
                        <td class="num">${el.id}</td>
                        <td class="user_id">${el.user_id}</td>
                        <td class="gender">${el.gender}</td>
                        <td class="role">${el.role}</td>
                        <td class="age">${el.age}</td>
                        <td class="nickname">${el.nickname}</td>
                        
                        
                    </table>
                        <button class="accept">  </button>
                        <button class="reject">  </button>
                </div>
        `

        const accept =document.querySelectorAll(".accept");
        const reject =document.querySelectorAll(".reject");

        accept.forEach((e,index)=>{
            e.onclick = async ()=>{

                console.log("클릭됨")
                console.log(index)

                const data =await axios.get(`${backend}/nonagreeuser`,{
                withCredentials:true,
                })

                
                
                data.data.forEach((e,indexx) => {
                    // console.log(index,indexx);
                    // console.log("Xxxxxxxx")
                    // console.log(typeof(e.grade));

                    if(index ==indexx){
                        e.grade = e.grade + 1;
                        // console.log(e.grade);
                        console.log(e.user_id);
                        axios.post(`${backend}/nonagreeuser`,{

                            withCredentials : true,

                            data :{
                                grade : e.grade,
                                user_id : e.user_id,
                            }
                        })
                    }
                });
                location.reload();
            }
        });

        reject.forEach((e,index)=>{
            e.onclick = async () =>{
                console.log("클릭");

                const data =await axios.get(`${backend}/nonagreeuser`,{
                withCredentials:true,
                })

                data.data.forEach((e,indexx) => {
                    // console.log(index,indexx);
                    // console.log("Xxxxxxxx")
                    // console.log(typeof(e.grade));

                    if(index ==indexx){
                        e.grade = e.grade - 1;
                        // console.log(e.grade);
                        console.log(e.user_id);
                        axios.post(`${backend}/nonagreeuser`,{

                            withCredentials : true,

                            data :{
                                grade : e.grade,
                                user_id : e.user_id,
                            }
                        })
                    }
                });

                location.reload();
            }
        })


    });
   }
   user_agree.onclick= async() =>{
    
    tab_title.innerText = "가입 승인";
    user_agree.style.color ="black";
    post_agree.style.color ="rgb(158, 158, 158)";
    chat_agree.style.color ="rgb(158, 158, 158)";

    
    main_content2.style.visibility="hidden";
    // main_content2.style.display="none";
    reject_reason.style.visibility = "hidden";
    main_content.style.display="block";

    //0619
    main_content3.style.display = "none";



    const data = await axios.get(`${backend}/nonagreeuser`,{

        withCredentials:true,
    })
    main_content.innerHTML ="";

    console.log(data);

    if(data.data.length==0){
        main_content.style.display="block";
        return main_content.innerHTML =`가입 승인 대기중인 유저가 없습니다.`
    }

    main_content.innerHTML =`
                    <br>
                    <table class="tb">
                        <th class="num">num</th>
                        <th class="user_id">user_id</th>
                        <th class="gender">M/W</th>
                        <th class="role">W/R</th>
                        <th class="age">age</th>
                        <th class="nickname">nickname</th>
                    </table>`
    // console.log(data);
    // console.log(data.data);

    data.data.forEach((el,index) => {
        
        main_content.innerHTML += 
        `       <div style="display:flex">
                    <table class="tb">
                        
                        <td class="num">${el.id}</td>
                        <td class="user_id">${el.user_id}</td>
                        <td class="gender">${el.gender}</td>
                        <td class="role">${el.role}</td>
                        <td class="age">${el.age}</td>
                        <td class="nickname">${el.nickname}</td>
                        
                        
                    </table>
                        <button class="accept">  </button>
                        <button class="reject">  </button>
                </div>
        `

        const accept =document.querySelectorAll(".accept");

        accept.forEach((e,index)=>{
            e.onclick = async ()=>{

                console.log("클릭됨")
                console.log(index)

                const data =await axios.get(`${backend}/nonagreeuser`,{
                withCredentials:true,
                })

                
                
                data.data.forEach((e,indexx) => {
                    // console.log(index,indexx);
                    // console.log("Xxxxxxxx")
                    // console.log(typeof(e.grade));

                    if(index ==indexx){
                        e.grade = e.grade + 1;
                        // console.log(e.grade);
                        console.log(e.user_id);
                        axios.post(`${backend}/nonagreeuser`,{

                            withCredentials : true,

                            data :{
                                grade : e.grade,
                                user_id : e.user_id,
                            }
                        })
                    }
                });

            }
        })
    });
   }
   closee.onclick = () =>{
    reject_reason.style.visibility = "hidden";
   }
   
   
   // 게시글 관리
   post_agree.onclick = async() =>{
    main_content2.innerHTML = "";
    main_content2.style.visibility = "visible";
    main_content.style.display="none";
    //0619
    main_content3.style.visibility = "hidden";

    tab_title.innerText = "게시글 관리";
    user_agree.style.color ="rgb(158, 158, 158)";
    post_agree.style.color ="black";
    chat_agree.style.color ="rgb(158, 158, 158)";
    console.log("클릭 되냐>?");
        const data = await axios.get(`${backend}/nonagreeuser/posts`,{
        withCredentials : true,
    })

        console.log(data);

        if(data.data.length==0){
        main_content2.style.visibility="visible";
        return main_content2.innerHTML =`승인 대기중인 게시글이 없습니다.`
    }

        data.data.forEach((el) => {
            console.log(el.img);
            

            main_content2.innerHTML += `
                <div class="book_img">
                <img src="${backend}/${el.img}" alt="">
                <div class="book_title">${el.title}</div>
                        <button class="accept2">  </button>
                        <button class="reject2">  </button>
                </div>
            `
        const accept2 =document.querySelectorAll(".accept2");
        const reject2 =document.querySelectorAll(".reject2");

        accept2.forEach((e,index)=>{
            e.onclick = async ()=>{

                console.log("클릭됨")
                console.log(index)

                const data =await axios.get(`${backend}/nonagreeuser/posts`,{
                withCredentials:true,
                })

                data.data.forEach((e,indexx) => {
                    // console.log(index,indexx);
                    // console.log("Xxxxxxxx")
                    // console.log(typeof(e.accept));

                    if(index ==indexx){
                        e.accept = parseInt(e.accept) + 1;
                        console.log(e.accept);
                        console.log(e.id);
                        axios.get(`${backend}/nonagreeuser/acceptUpdate`,{

                            withCredentials : true,

                            params :{
                                accept : e.accept,
                                id : e.id,
                            }
                        })
                    }
                });
                location.reload();
            }
        });

        reject2.forEach((e,index)=>{
            
        e.onclick = async()=>{
            reject_reason.style.visibility = "visible";

            rejectbtn.onclick = async () =>{

                
                // reject_reason.style.display = "block";

                const reasonvalue = reason.options[reason.selectedIndex].value;
                console.log("클릭");

                const data =await axios.get(`${backend}/nonagreeuser/posts`,{
                withCredentials:true,
                })

                data.data.forEach((e,indexx) => {
                    console.log(index,indexx);
                    console.log("Xxxxxxxx")
                    console.log(typeof(e.accept));

                    if(index ==indexx){
                        e.accept = parseInt(e.accept) - 1;
                        console.log(e.grade);
                        console.log(e.id);
                        axios.get(`${backend}/nonagreeuser/acceptUpdate`,{

                            withCredentials : true,

                            params :{
                                accept : e.accept,
                                id : e.id,
                                reject : reasonvalue,
                            }
                        })
                    }
                });
                reject_reason.style.visibility = "hidden";
                location.reload();
            }
        }
        })

        });
   }

//    rejectbtn.onclick = () =>{
//         console.log(reason.options[reason.selectedIndex].value);
//         const reasonvalue = reason.options[reason.selectedIndex].value;
        
//         axios.get("http://127.0.0.1:8080/nonagreeuser/rejectUpdate",{

//             withCredentials: true,

//             params : {
//                 reject : reasonvalue,
//             }
//         })
//    }


   chat_agree.onclick = async () => {
        let chatUserId = document.querySelector(".chat_user_id");
        tab_title.innerText = "고객 문의";
        user_agree.style.color = "rgb(158, 158, 158)";
        post_agree.style.color = "rgb(158, 158, 158)";
        chat_agree.style.color = "black";

        //0619
        chatUserId.innerHTML = "";
        main_content3.style.display = "block";
        main_content3.style.visibility = "visible";
        main_content2.style.visibility = "hidden";
        main_content.style.display = "none";

        let chatArea = document.querySelector(".chatArea");

        
        // confirm 이 0인 값을 가져와보자.
        const confirmZero = await axios.get(`${backend}/chat/confirmZero`,{
            withCredentials:true,
        })

        console.log(confirmZero.data);

        confirmZero.data.forEach((el,index) => {
            console.log(el)
        });

       
        // 채팅을 한번이라도 한 유저 이름 가져와야함
        const un = await axios.get(`${backend}/chat/username`, {
            withCredentials: true,
        })

        const socket = io.connect(`${backend}`);
            let chat_id;
            const userName = "admin";
            let userTemp;
            let chatUserInfo;

            console.log(un.data);
            

            confirmZero.data.forEach((el,index) => {
            // const { user_name } = el;
            // console.log(user_name);
            if(el.zeroCnt == 0){
                chatUserId.innerHTML +=
                `
             <li class="userClick"><span class="usn">${el.user_name}</span>
            </li>`
                
            } else {
            chatUserId.innerHTML +=
                `
             <li class="userClick"><span class="usn">${el.user_name}</span><span class="zeroCnt">${el.zeroCnt}</span>
            </li>
                                  
            `}
            //usn : User Span Name 
            let userClick = document.querySelectorAll(".userClick");
            let usn = document.querySelectorAll(".usn")

            userClick.forEach((el, index) => {
                el.style.backgroundColor="";
                el.onclick = async(e) => {
                    console.log(e.target.querySelector(".zeroCnt"));
                    const zeroCnt = e.target.querySelector(".zeroCnt");

                    zeroCnt.style.display="none";

                    chatArea.innerHTML = "";
                    if (userTemp) {
                        socket.emit("leaveRoom", chat_id);
                    }
                    // el.style.backgroundColor="red"
                    console.log(index + "누름");
                    let str = confirmZero.data[index].user_name;
                    console.log(str)

                    who_room.innerText = str;

                    chatUserInfo = await axios.get(`${backend}/chat/getUserInfo`, {
                        withCredentials: true,
                        params: {
                            user_id: str,
                        } 
                    });
                    chat_id = chatUserInfo.data.id;
                    console.log(chat_id);

                    socket.emit("joinRoom", chat_id);

                    // 소켓 연결됬을때 카톡 읽은것처럼 1로 바꿈.
                    // console.log(socket.on("joinRoom", chat_id))

                    if(socket.emit("joinRoom", chat_id).connected){

                        const data = axios.get(`${backend}/chat/changeone`,{
                            withCredentials : true,

                            params : {
                                chat_id : chat_id,
                            }
                        })
                    
                    }
                    userTemp = chat_id;

                    console.log(str)
                    console.log(chat_id);

                    const chatdata = await axios.get(
                        `${backend}/chat/getChatData`,
                        {
                            withCredentials: true,
                            params: {
                                id: chat_id,
                            },
                        }
                    );

                    console.log(chatdata);
                    

                    chatdata.data.forEach((el, index) => {
                        console.log(el.chat_id, el.user_name, el.text);
                        
                        if(el.user_name=="admin"){

                            chatArea.innerHTML += `
    
                                <span class="adminSpan">${el.text}</span>
                            `
                        }
                        else{
                            chatArea.innerHTML += `
    
                                <span class="userSpan">${el.text}</span>
                            `
                        }
                    });
                    // 대화한 내용이 창을 벗어나 스크롤이 생기면 맨 아래 부터 보게 하기
                    setTimeout(() => {
                        chatArea.scrollTop = chatArea.scrollHeight;
                    }, 0);
                }
            });
        });

        sendBtn.onclick = () => {
           // console.log(user_name);
           socket.emit("message", chat_id, userName, adminMsg.value);
           adminMsg.value ="";
        };

        socket.on("message", (chat_id, user_name, msg) => {
           console.log(chat_id, " ", user_name, " ", msg); 
           if (user_name == "admin") {

                chatArea.innerHTML += `

                <span class="adminSpan">${msg}</span>
                `
            }
            else {
                chatArea.innerHTML += `

            <span class="userSpan">${msg}</span>
                `
            }
            // 대화한 내용이 창을 벗어나 스크롤이 생기면 맨 아래 부터 보게 하기
            chatArea.scrollTop = chatArea.scrollHeight;
       });
        
    }
   
</script>
<!-- <script src="./js/adminChat.js"></script> -->
</html>